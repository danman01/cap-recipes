#user  nobody;
worker_processes  1;

# nginx  file limits.
worker_rlimit_nofile 40000;

# ===SYSLOG===
# Sytax: syslog auth|authpriv|cron|daemon|ftp|kern|local0-7|lpr|mail|news|syslog|user|uucp [program_name]
# Default: none
# Context: main
# 
# Enable the syslog and set its facility. The default program name is nginx.
# 
# ===ERROR_LOG===
# Syntax: error_log [syslog[:emerg|alert|crit|error|warn|notice|info|debug]]['|'file] [ debug | info | notice | warn | error | crit ]
# Default: ${prefix}/logs/error.log
# Context: main, http, server, location
# 
# Enable the error_log with the syslog and set its priority. The default priority is error. The error log can be sent to syslog, file or both. 
# 
# Note: if you set the error_log directive in the main block, the syslog is switched on by default.
# 
# ===ACCESS_LOG===
# Syntax: access_log off|[syslog[:emerg|alert|crit|error|warn|notice|info|debug]]['|'path] [format [buffer=size]]]
# Default: access_log logs/access.log combined
# Context: http, server, location
# 
# Enable the access_log with the syslog and set its priority. The default priority is notice. The access log can be sent to syslog, file or both.

syslog local6 <%=nginx_passenger_init_d%>;

error_log syslog:info|<%=nginx_passenger_log_dir%>/error.log;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

pid        <%=nginx_passenger_pid%>;


events {
  worker_connections  30000;
  use epoll;
}


http {
    passenger_root <%=capture("#{base_ruby_path}/bin/gem env gemdir").chomp%>/gems/passenger-<%=nginx_passenger_ver%>;
    passenger_ruby <%=base_ruby_path%>/bin/ruby;
    passenger_max_pool_size <%=fetch(:nginx_passenger_max_pool_size,"30")%>;
    passenger_pool_idle_time <%=fetch(:nginx_passenger_pool_idle_time,"10")%>;

    include       mime.types;
    types {
      audio/x-wav wav;
    }
    default_type  application/octet-stream;
    
    # ssl_certificate <%=nginx_unicorn_root%>/wildcard.homerun.com.crt;
    # ssl_certificate_key <%=nginx_unicorn_root%>/wildcard.homerun.com.key;
    ssl_protocols        SSLv3 TLSv1;

    # http://matt.io/technobabble/hivemind_devops_alert:_nginx_does_not_suck_at_ssl/ur
    # http://news.ycombinator.com/item?id=2759596
    # You can force nginx to not enable the expensive cipher by excluding all DHE ciphers.
    # Add "!kEDH" to your cipher list. It disables (the ! disables) any cipher using
    # Ephemeral Diffie-Hellman.
    ssl_ciphers          HIGH:!ADH:!MD5:!kEDH;

    server_names_hash_bucket_size 128;

    log_format timing '$remote_addr - $remote_user [$time_local] $scheme $request $status '
      'upstream_response_time $upstream_response_time '
      'msec $msec request_time $request_time';
      
    log_format  main  '$remote_addr - $remote_user [$time_local] $request '
        '"$status" $body_bytes_sent "$http_referer" '
        '"$http_user_agent" "$http_x_forwarded_for"';

    access_log syslog:info main;
    error_log syslog:info;

    client_body_temp_path   '/dev/shm';
    server_name_in_redirect on;
    ignore_invalid_headers  on;

    keepalive_timeout       65;

    #default: keepalive_requests 100
    keepalive_requests      20;
    sendfile                on;
    tcp_nodelay             on;
    tcp_nopush              on;

    gzip  on;
    gzip_http_version 1.0;
    gzip_min_length 0;
    gzip_buffers 16 8k;
    gzip_comp_level 6;
    gzip_static on;
    gzip_proxied any;
    gzip_vary on;
    gzip_types text/plain text/javascript text/css application/x-javascript text/xml;

    ##
    # Optimizations: http://www.typemiss.net/blog/kounoike/20060227-75
    client_header_timeout         10m;
    client_body_timeout           10m;
    send_timeout                  10m;

    connection_pool_size          256;
    client_header_buffer_size     12k;
    large_client_header_buffers   4 8k;
    request_pool_size             4k;

    output_buffers                1 32k;
    postpone_output               1460;

    include <%="#{nginx_passenger_root}"%>/conf/sites-enabled/*;

}
