server {
  listen <%=nginx_unicorn_port%>;
  server_name <%=nginx_unicorn_server_name%>;
  root <%=deploy_to%>/current/public;   # <--- be sure to point to 'public'!
  
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header Host $http_host;
  proxy_redirect   off;
  
  location ~ ^/(flash|pdf|images|javascripts|stylesheets|compiled|fonts|attachments)/ {
    expires      180d;
    access_log    off;
  }

  location / {
    if (!-f $request_filename) {
      proxy_pass http://<%=application%>_unicorn;
      break;
    }
  }
  
}

# Only one Upstream should exist.
upstream <%=application%>_unicorn {
  # it is recommended to set “fail_timeout=0” for in your nginx configuration like this to have nginx always retry backends that may have had workers SIGKILL-ed due to timeouts.
  # may be proxy_upstream_fail_timeout in our version of nginx
  server unix:<%=shared_path%>/sockets/unicorn.sock;
}